{% extends 'base.html' %}
{% block content %}
<div class="container-fluid p-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-4">Home</h2>
        </div>
    </div>


    <!-- Balance Cards - Redesigned -->
    <div class="row mb-4 g-4">
        <!-- Total Balance Card -->
        <div class="col-md-4">
            <div class="balance-card balance-card-primary">
                <div class="balance-card-glow"></div>
                <div class="balance-card-content">
                    <div class="balance-card-header">
                        <div class="balance-card-icon-wrapper">
                            <div class="balance-card-icon">
                                <i class="bi bi-wallet2"></i>
                            </div>
                        </div>
                        <div class="balance-card-title">
                            <span class="balance-card-label">Total Balance</span>
                            <div class="balance-card-status">
                                <div class="status-dot active"></div>
                                <span>Available</span>
                            </div>
                        </div>

                    </div>
                    <div class="balance-card-amount">
                        <span class="currency-symbol">$</span>
                        <span class="amount-value">${{ user.balance|default('0.00') }}</span>
                    </div>
                    <div class="balance-card-footer">
                        <div class="card-pattern"></div>
                        <div class="balance-trend">
                            <i class="bi bi-graph-up trend-icon"></i>
                            <span class="trend-text">+2.5% this week</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Monthly Net Card -->
        <div class="col-md-4">
            <div class="balance-card balance-card-secondary">
                <div class="balance-card-glow"></div>
                <div class="balance-card-content">
                    <div class="balance-card-header">
                        <div class="balance-card-icon-wrapper">
                            <div class="balance-card-icon">
                                <i class="bi bi-arrow-up-right"></i>
                            </div>
                        </div>
                        <div class="balance-card-title">
                            <span class="balance-card-label">Net This Month</span>
                            <div class="balance-card-status">
                                <div class="status-dot processing"></div>
                                <span>Tracking</span>
                            </div>
                        </div>
                    </div>
                    <div class="balance-card-amount">
                        <span class="currency-symbol">$</span>
                        <span class="amount-value" id="monthlyDifference">0.00</span>

                    </div>
                    <div class="balance-card-footer">
                        <div class="card-pattern"></div>
                        <div class="balance-details">
                            <small id="monthlyEarnedSpent" class="earned-spent-text"></small>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Budget Card -->
        <div class="col-md-4">
            <div class="balance-card balance-card-accent">
                <div class="balance-card-glow"></div>
                <div class="balance-card-content">
                    <div class="balance-card-header">
                        <div class="balance-card-icon-wrapper">
                            <div class="balance-card-icon">
                                <i class="bi bi-piggy-bank"></i>
                            </div>
                        </div>
                        <div class="balance-card-title">
                            <div class="budget-dropdown-wrapper">
                                <div class="dropdown">
                                    <button class="budget-selector" data-bs-toggle="dropdown" aria-expanded="false">
                                        <span id="budgetName" class="budget-name">{{ budgets[0].name if budgets else 'No Budget' }}</span>
                                        <i class="bi bi-chevron-down dropdown-arrow"></i>
                                    </button>
                                    <ul class="dropdown-menu budget-dropdown-menu">
                                        {% for budget in budgets %}
                                        <li>
                                            <a class="dropdown-item budget-option" href="#"
                                                onclick="selectDisplayBudget('{{ budget.id }}', '{{ budget.name }}', '{{ budget.currency if budget.currency else '$' }}', '{{ '%.2f'|format(budget.amount if budget.amount else 0) }}');return false;">
                                                <div class="budget-option-content">
                                                    <span class="budget-option-name">{{ budget.name }}</span>
                                                    <span class="budget-option-amount">{{ budget.currency if budget.currency else '$' }}{{ '%.2f'|format(budget.amount if budget.amount else 0) }}</span>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>
                            <div class="balance-card-status">
                                <div class="status-dot budget"></div>
                                <span>Budget</span>
                            </div>
                        </div>

                    </div>
                    <div class="balance-card-amount">
                        <span class="currency-symbol" id="budgetCurrency">{{ budgets[0].currency if budgets and budgets[0].currency else '$' }}</span>
                        <span class="amount-value" id="budgetAmount">{{ '%.2f'|format(budgets[0].amount if budgets and budgets[0].amount else 0) }}</span>
                    </div>
                    <div class="balance-card-footer">
                        <div class="card-pattern"></div>
                        <div class="budget-progress" style="margin-top: -1vw;">
                            <div class="progress-bar-wrapper">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 65%"></div>
                                </div>
                                <span class="progress-text">65% used</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Transaction Reports Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Transaction Reports</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="reportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="reportDropdownLabel">Monthly</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"
                                    onclick="loadReport('monthly');return false;">Monthly</a></li>
                            <li><a class="dropdown-item" href="#"
                                    onclick="loadReport('yearly');return false;">Yearly</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position:relative; width:100%; height:380px; background: linear-gradient(145deg, #0f0f0f, #1a1a1a); border-radius: 12px; padding: 20px;">
                        <canvas id="transactionChart" style="width:100%;height:100%;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions Card -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Recent Transactions</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Today
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Today</a></li>
                            <li><a class="dropdown-item" href="#">Yesterday</a></li>
                            <li><a class="dropdown-item" href="#">This Week</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if transactions %}
                    <div class="table-responsive">
                        <table class="transaction-table dashboard-transaction-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr>
                                    <td>
                                        <div class="transaction-account">
                                            <div class="transaction-icon">
                                                {% if tx.type|lower == 'payment' %}
                                                <i class="bi bi-credit-card text-primary"></i>
                                                {% elif tx.type|lower == 'transfer' %}
                                                <i class="bi bi-arrow-left-right text-success"></i>
                                                {% elif tx.type|lower == 'withdrawal' %}
                                                <i class="bi bi-cash text-danger"></i>
                                                {% else %}
                                                <i class="bi bi-currency-exchange text-warning"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="transaction-vendor">{{ tx.type|capitalize }}</div>
                                                <div class="transaction-category">
                                                    {% if tx.sender_id == user.id %}
                                                    Sent{% if tx.receiver_id %} to {{ tx.receiver_id }}{% endif %}
                                                    {% elif tx.receiver_id == user.id %}
                                                    Received{% if tx.sender_id %} from {{ tx.sender_id }}{% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div
                                            class="transaction-amount {{ 'amount-negative' if tx.sender_id == user.id else 'amount-positive' }}">
                                            {{ '-' if tx.sender_id == user.id else '+' }}${{ tx.amount }}
                                        </div>
                                    </td>
                                    <td>{{ tx.timestamp|format_date }}</td>
                                    <td>
                                        <span class="transaction-status
    {% if tx.status|lower == 'completed' %}
        success
    {% elif tx.status|lower == 'pending' %}
        pending
    {% else %}
        canceled
    {% endif %}">
                                            {{ tx.status|default('Completed')|capitalize }}
                                        </span>
                                    </td>
                                    <td class="transaction-time">{{ tx.timestamp|format_time }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div> {% else %}
                    <div class="no-transactions">
                        <i class="bi bi-credit-card"></i>
                        <h5>No transactions yet</h5>
                        <p>Your recent transactions will appear here</p>
                    </div>
                    {% endif %}
                    <a href="{{ url_for('transaction.send_money_route') }}" class="view-all-link">View All
                        Transactions</a>
                </div>
            </div>
        </div>

        <!-- Right column: Budgets and Expenses -->
        <div class="col-lg-4">
            <!-- Expenses Card (now below Budgets) -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Expenses</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="budgetDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="budgetDropdownLabel">{{ budgets[0].name if budgets else 'No Budgets' }}</span>
                        </button>
                        <ul class="dropdown-menu" id="budgetDropdownMenu">
                            {% for budget in budgets %}
                            <li>
                                <a class="dropdown-item" href="#"
                                    onclick="selectBudget('{{ budget.id }}', '{{ budget.name }}');return false;">
                                    {{ budget.name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h3 class="mb-0" id="expenseTotal">$0</h3>
                        <p class="text-muted">Total</p>
                    </div>
                    <div class="expense-chart-scrollbox">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    Category Budget Summary
                </div>
                <div class="card-body p-0">
                    <div id="category-summary-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Set current year for card expiration date
    document.addEventListener('DOMContentLoaded', function () {
        const currentYear = new Date().getFullYear();
        const expiryElements = document.querySelectorAll('.credit-card-inner .text-end div:last-child');
        expiryElements.forEach(el => {
            if (el.innerText.includes('/')) {
                el.innerText = `12/${currentYear + 1}`;
            }
        });
    });

    function drawHistogram(labels, received, spent, year, period) {
        const canvas = document.getElementById('transactionChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const width = canvas.width;
        const height = canvas.height;
        
        // Set dark background
        ctx.fillStyle = "#0f0f0f";
        ctx.fillRect(0, 0, width, height);

        // Draw year at top center if monthly
        if (period === 'monthly' && year) {
            ctx.fillStyle = "#ffffff";
            ctx.font = "18px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(year, width / 2, 25);
        }

        const barWidth = Math.floor((width - 100) / labels.length);
        const maxVal = Math.max(...received, ...spent, 1);
        const chartHeight = height - 80;
        const chartBottom = height - 40;

        // Draw subtle grid lines
        ctx.strokeStyle = "rgba(255, 255, 255, 0.05)";
        ctx.lineWidth = 1;
        for (let i = 0; i <= 5; i++) {
            const y = chartBottom - (i / 5) * chartHeight;
            ctx.beginPath();
            ctx.moveTo(50, y);
            ctx.lineTo(width - 20, y);
            ctx.stroke();
        }

        // Draw bars with gradients
        for (let i = 0; i < labels.length; i++) {
            const x = 50 + i * barWidth + barWidth * 0.2;
            const barWidthActual = barWidth * 0.6;

            // Calculate bar heights
            const receivedHeight = (received[i] / maxVal) * chartHeight;
            const spentHeight = (spent[i] / maxVal) * chartHeight;
            const totalHeight = Math.max(receivedHeight, spentHeight);

            // Create gradient for received (green to cyan)
            const receivedGradient = ctx.createLinearGradient(0, chartBottom - receivedHeight, 0, chartBottom);
            receivedGradient.addColorStop(0, "#00d4aa");
            receivedGradient.addColorStop(0.5, "#00ff9f");
            receivedGradient.addColorStop(1, "#00b4d8");

            // Create gradient for spent (red to orange)
            const spentGradient = ctx.createLinearGradient(0, chartBottom - spentHeight, 0, chartBottom);
            spentGradient.addColorStop(0, "#ef4444");
            spentGradient.addColorStop(0.5, "#ff6b6b");
            spentGradient.addColorStop(1, "#ff8e53");

            // Function to draw rounded rectangle
            function drawRoundedRect(ctx, x, y, width, height, radius) {
                ctx.beginPath();
                ctx.moveTo(x + radius, y);
                ctx.lineTo(x + width - radius, y);
                ctx.quadraticCurveTo(x + width, y, x + width, y + radius);
                ctx.lineTo(x + width, y + height - radius);
                ctx.quadraticCurveTo(x + width, y + height, x + width - radius, y + height);
                ctx.lineTo(x + radius, y + height);
                ctx.quadraticCurveTo(x, y + height, x, y + height - radius);
                ctx.lineTo(x, y + radius);
                ctx.quadraticCurveTo(x, y, x + radius, y);
                ctx.closePath();
            }

            // Draw received bar with rounded corners
            if (received[i] > 0) {
                ctx.fillStyle = receivedGradient;
                drawRoundedRect(ctx, x, chartBottom - receivedHeight, barWidthActual * 0.45, receivedHeight, 4);
                ctx.fill();
                
                // Add subtle border
                ctx.strokeStyle = "rgba(0, 212, 170, 0.3)";
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // Draw spent bar with rounded corners
            if (spent[i] > 0) {
                ctx.fillStyle = spentGradient;
                drawRoundedRect(ctx, x + barWidthActual * 0.55, chartBottom - spentHeight, barWidthActual * 0.45, spentHeight, 4);
                ctx.fill();
                
                // Add subtle border
                ctx.strokeStyle = "rgba(239, 68, 68, 0.3)";
                ctx.lineWidth = 1;
                ctx.stroke();
            }

            // Draw labels
            ctx.fillStyle = "#6b7280";
            ctx.font = "11px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
            ctx.textAlign = "center";
            ctx.fillText(labels[i], x + barWidthActual / 2, height - 15);
        }

        // Draw Y-axis values
        ctx.fillStyle = "#6b7280";
        ctx.font = "11px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
        ctx.textAlign = "right";
        for (let i = 0; i <= 5; i++) {
            const value = Math.round((i / 5) * maxVal);
            const y = chartBottom - (i / 5) * chartHeight;
            ctx.fillText(value.toLocaleString(), 45, y + 4);
        }

        // Modern legend with gradient boxes
        const legendY = 20;
        const legendX = width - 120;

        // Received legend with rounded corners
        const receivedLegendGradient = ctx.createLinearGradient(legendX, legendY, legendX, legendY + 12);
        receivedLegendGradient.addColorStop(0, "#00d4aa");
        receivedLegendGradient.addColorStop(1, "#00b4d8");
        ctx.fillStyle = receivedLegendGradient;
        drawRoundedRect(ctx, legendX, legendY, 12, 12, 3);
        ctx.fill();
        ctx.fillStyle = "#ffffff";
        ctx.font = "12px -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
        ctx.textAlign = "left";
        ctx.fillText("Received", legendX + 18, legendY + 9);

        // Spent legend with rounded corners
        const spentLegendGradient = ctx.createLinearGradient(legendX, legendY + 20, legendX, legendY + 32);
        spentLegendGradient.addColorStop(0, "#ef4444");
        spentLegendGradient.addColorStop(1, "#ff8e53");
        ctx.fillStyle = spentLegendGradient;
        drawRoundedRect(ctx, legendX, legendY + 20, 12, 12, 3);
        ctx.fill();
        ctx.fillStyle = "#ffffff";
        ctx.fillText("Spent", legendX + 18, legendY + 29);
    }

    function loadReport(period) {
        document.getElementById('reportDropdownLabel').innerText =
            period.charAt(0).toUpperCase() + period.slice(1);
        localStorage.setItem('transactionReportPeriod', period);
        fetch(`/api/transaction-report?period=${period}`)
            .then(res => res.json())
            .then(data => {
                drawHistogram(data.labels, data.received, data.spent, data.year, period);
            });
    }

    function resizeChart() {
        const canvas = document.getElementById('transactionChart');
        const container = canvas.parentElement;
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
    }
    document.addEventListener('DOMContentLoaded', resizeChart);
    window.addEventListener('resize', resizeChart);

    // Initial load
    document.addEventListener('DOMContentLoaded', function () {
        // Set canvas size
        const canvas = document.getElementById('transactionChart');
        canvas.width = 600;
        canvas.height = 250;
        const lastperiod = localStorage.getItem('transactionReportPeriod');
        if (lastperiod === 'weekly') {
            loadReport('monthly'); // fallback to monthly if previously set to weekly
        } else {
            loadReport(lastperiod || 'monthly');
        }
    });

    // function selectBudget(budgetId, budgetName) {
    //     document.getElementById('budgetDropdownLabel').innerText = budgetName;
    //     const expenseTotalEl = document.getElementById('expenseTotal');
    //     // Fetch and update expense chart data for the selected budget
    //     fetch(`/api/expense-report?budget_id=${budgetId}`)
    //         .then(res => res.json())
    //         .then(data => {
    //             // Update total amount
    //             expenseTotalEl.innerText = `$${data.totalAmount.toFixed(2)}`;
    //             // Update chart
    //             const ctx = document.getElementById('expenseChart').getContext('2d');
    //             ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    //             const labels = data.expenses.map(expense => expense.date);
    //             const amounts = data.expenses.map(expense => expense.amount);
    //             new Chart(ctx, {
    //                 type: 'bar',
    //                 data: {
    //                     labels: labels,
    //                     datasets: [{
    //                         label: 'Expenses',
    //                         data: amounts,
    //                         backgroundColor: '#3ed6c2',
    //                         borderColor: '#3ed6c2',
    //                         borderWidth: 1
    //                     }]
    //                 },
    //                 options: {
    //                     responsive: true,
    //                     scales: {
    //                         y: {
    //                             beginAtZero: true
    //                         }
    //                     }
    //                 }
    //             });
    //         });
    // }
    const categoryColors = {
        'Housing': '#FF6384',
        'Utilities': '#36A2EB',
        'Groceries': '#FFCE56',
        'Transportation': '#8A5FFF',
        'Healthcare': '#3ED6C2',
        'Insurance': '#FF9F40',
        'Education': '#4BC0C0',
        'Savings': '#9966FF',
        'Debt Payments': '#C9CBCF',
        'Personal Care': '#FF6384',
        'Entertainment': '#36A2EB',
        'Dining Out': '#FFCE56',
        'Clothing': '#8A5FFF',
        'Gifts & Donations': '#3ED6C2',
        'Travel': '#FF9F40',
        'Childcare': '#4BC0C0',
        'Pets': '#9966FF',
        'Other': '#C9CBCF'
    };

    let budgetsData = {{ budgets| tojson }};
    console.log("budgetsData:", budgetsData);
    let expenseChart;
    let currentBudgetId = localStorage.getItem('selectedBudgetId') || (budgetsData.length ? budgetsData[0].id : null);

    function selectBudget(budgetId, budgetName) {
        document.getElementById('budgetDropdownLabel').innerText = budgetName;
        currentBudgetId = budgetId;
        localStorage.setItem('selectedBudgetId', budgetId);
        updateExpenseChart();
    }

    function updateExpenseChart() {
        console.log("Calling updateExpenseChart");
        const budget = budgetsData.find(b => b.id == currentBudgetId);
        if (!budget) return;
        const categories = budget.categories || {};
        const labels = [];
        const data = [];
        const colors = [];
        for (const catName in categories) {
            labels.push(catName);
            let amount = categories[catName] || 0;
            data.push(amount);
            colors.push(categoryColors[catName] || '#C9CBCF');
        }
        // Calculate total and percentages
        const total = data.reduce((a, b) => a + b, 0);
        document.getElementById('expenseTotal').innerText = '$' + total.toFixed(2);

        // Update Chart.js
        if (expenseChart) {
            expenseChart.data.labels = labels;
            expenseChart.data.datasets[0].data = data;
            expenseChart.data.datasets[0].backgroundColor = colors;
            expenseChart.options.plugins.tooltip.callbacks = {
                label: function (context) {
                    const value = context.parsed;
                    const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                    return `${context.label}: $${value} (${percent}%)`;
                }
            };
            expenseChart.update();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Chart.js
        const ctx = document.getElementById('expenseChart').getContext('2d');
        console.log("Creating Chart.js doughnut chart");
        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                // This will be overwritten in updateExpenseChart
                                return '';
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });
        updateExpenseChart();
    });

    function selectDisplayBudget(budgetId, name, currency, amount) {
        document.getElementById('budgetName').textContent = name || 'No Budget';
        document.getElementById('budgetCurrency').textContent = currency || '$';
        // Always show two decimals
        document.getElementById('budgetAmount').textContent = parseFloat(amount).toFixed(2);
        
        // Add animation effect
        const amountElement = document.getElementById('budgetAmount');
        amountElement.style.transform = 'scale(1.1)';
        setTimeout(() => {
            amountElement.style.transform = 'scale(1)';
        }, 200);
        
        // Update progress bar (mock data for now)
        const progressFill = document.querySelector('.progress-fill');
        const progressText = document.querySelector('.progress-text');
        const usedPercentage = Math.min(Math.random() * 80 + 20, 95); // Random between 20-95%
        
        if (progressFill && progressText) {
            progressFill.style.width = usedPercentage + '%';
            progressText.textContent = Math.round(usedPercentage) + '% used';
        }
    }

    // Initialize with the first budget on page load
    document.addEventListener('DOMContentLoaded', function () {
        // Add staggered animation to balance cards
        const balanceCards = document.querySelectorAll('.balance-card');
        balanceCards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(30px)';
            setTimeout(() => {
                card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 200 + 100);
        });

        if (budgetsData && budgetsData.length > 0) {
            const firstBudget = budgetsData[0];
            selectDisplayBudget(
                firstBudget.id,
                firstBudget.name,
                firstBudget.currency || '$',
                firstBudget.amount || 0
            );
        }
        
        // Simulate real-time updates for demo purposes
        setTimeout(() => {
            const trendText = document.querySelector('.trend-text');
            if (trendText) {
                trendText.style.color = '#00ff9f';
                trendText.style.fontWeight = '600';
            }
        }, 2000);
    });
    console.log("Pie chart JS loaded");

    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/category-summary')
            .then(res => res.json())
            .then(data => {
                let html = `<div class="category-summary-scrollbox"><table class="category-summary-table table mb-0">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Budget</th>
                            <th>Spent</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>`;
                data.forEach(row => {
                    // Determine color for condition
                    let condColor = row.condition.includes('remaining') ? 'text-success' : 'text-danger';
                    let categoryIcon = getCategoryIcon(row.category);
                    html += `<tr>
                        <td>
                            <div class="transaction-account">
                                <div class="transaction-icon">
                                    <i class="${categoryIcon}"></i>
                                </div>
                                <div>
                                    <div class="transaction-vendor">${row.category}</div>
                                </div>
                            </div>
                        </td>
                        <td><strong>$${row.budget.toFixed(2)}</strong></td>
                        <td><strong>$${row.expenditure.toFixed(2)}</strong></td>
                        <td><span class="${condColor}">${row.condition}</span></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
                document.getElementById('category-summary-table').innerHTML = html;
            });
    });

    function getCategoryIcon(category) {
        const iconMap = {
            'Housing': 'bi bi-house-fill text-primary',
            'Utilities': 'bi bi-lightning-fill text-warning',
            'Groceries': 'bi bi-cart-fill text-success',
            'Transportation': 'bi bi-car-front-fill text-info',
            'Healthcare': 'bi bi-heart-pulse-fill text-danger',
            'Insurance': 'bi bi-shield-fill text-secondary',
            'Education': 'bi bi-book-fill text-primary',
            'Savings': 'bi bi-piggy-bank-fill text-success',
            'Debt Payments': 'bi bi-credit-card-fill text-warning',
            'Personal Care': 'bi bi-person-fill text-info',
            'Entertainment': 'bi bi-play-circle-fill text-purple',
            'Dining Out': 'bi bi-cup-hot-fill text-warning',
            'Clothing': 'bi bi-bag-fill text-secondary',
            'Gifts & Donations': 'bi bi-gift-fill text-danger',
            'Travel': 'bi bi-airplane-fill text-info',
            'Childcare': 'bi bi-people-fill text-primary',
            'Pets': 'bi bi-heart-fill text-success',
            'Other': 'bi bi-three-dots text-secondary'
        };
        return iconMap[category] || 'bi bi-circle-fill text-secondary';
    }

    // Fetch monthly earned and spent, then show the difference
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/transaction-report?period=monthly')
            .then(res => res.json())
            .then(data => {
                const monthIndex = new Date().getMonth();
                const earned = data.received[monthIndex] || 0;
                const spent = data.spent[monthIndex] || 0;
                const difference = earned - spent;

                document.getElementById('monthlyDifference').innerText =
                    (difference >= 0 ? '+' : '') + '$' + difference.toFixed(2);
                document.getElementById('monthlyEarnedSpent').innerText =
                    `Earned: $${earned.toFixed(2)} | Spent: $${spent.toFixed(2)}`;
            });
    });
</script>
<style>
    .backgruond {
        z-index: 0;
    }

    .stats-card-budget {
        background-color: #5a67d8;
        background-image: linear-gradient(40deg, #5a67d8 0%, #7c3aed 100%);
        color: white;
        z-index: 0;
    }

    .stats-card-budget .stats-icon {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .stats-card-budget h5 {
        color: #e2e8f0;
        margin-bottom: 8px;
    }

    .stats-card-budget .dropdown-toggle::after {
        margin-left: 0.5em;
        vertical-align: middle;
    }

    .stats-card-budget .dropdown-menu {
        max-height: 80 px;
        overflow-y: auto;
        z-index: 3;
    }

    #budgetCurrency {
        font-size: 1 rem;
        /* or any size you prefer */
        font-weight: bold;
    }

    #budgetAmount {
        font-size: 2.2rem;
        /* or any size you prefer */
        font-weight: bold;
    }

    .expense-chart-scrollbox {
        height: 300px;
        /* Fixed height for the chart area */
        overflow-y: auto;
        /* Enable vertical scrolling */
        padding: 10px 0;
        position: relative;
        background: transparent;
        /* Or your card background */
    }

    /* Make sure the canvas fills the scrollbox */
    #expenseChart {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    /* Match the height of the recent transactions section */
    .category-summary-scrollbox {
        height: 485px;
        overflow-y: auto;
        background: transparent;
        padding: 0;
    }

    .category-summary-table {
        width: 100%;
        background: linear-gradient(145deg, var(--gradient-color-1), var(--dark-secondary), var(--dark-tertiary));
        border-radius: 0;
        overflow: hidden;
        border-collapse: separate;
        border-spacing: 0;
        margin: 0;
    }

    .category-summary-table th {
        text-align: left;
        padding: 16px 20px;
        font-weight: 500;
        color: var(--text-secondary);
        font-size: 0.85rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        background: transparent;
        position: sticky;
        top: 0;
        z-index: 2;
    }

    .category-summary-table td {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        vertical-align: middle;
        background: transparent;
        color: var(--text-primary);
        font-size: 0.9rem;
    }

    .category-summary-table tr:last-child td {
        border-bottom: none;
    }

    .category-summary-table tr:hover {
        background-color: rgba(255, 255, 255, 0.03);
    }

    .text-success {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        background-color: rgba(40, 167, 69, 0.15);
        color: var(--success-color) !important;
    }

    .text-danger {
        display: inline-block;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        background-color: rgba(220, 53, 69, 0.15);
        color: var(--danger-color) !important;
    }

    .balance-amount {
        font-size: 2.5rem !important;
        font-weight: bold !important;
    }

    .md {
        font-size: 1.8rem !important;
        font-weight: bold !important;
    }

    /* Make the budget dropdown always appear above other content */
    /* Make the budget dropdown scrollable and always above other content */
    .budget-dropdown-menu {
        position: absolute !important;
        z-index: 1050 !important;
        /* Very high, above modals and backgrounds */
        left: 0;
        top: 100%;
        min-width: 100%;

        max-height: 400px !important;
        /* Increased max height for better visibility */

        overflow-y: auto;
        /* Enable vertical scrolling */
        background: rgba(30, 30, 30, 0.95) !important;
        color: white !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3) !important;
        border: 1px solid rgba(255, 255, 255, 0.1) !important;
        border-radius: 16px !important;
        backdrop-filter: blur(20px);
        padding: 8px !important;
    }

    /* Prevent parent from clipping dropdown */
    .balance-card-accent {
        overflow: visible !important;
        position: relative;
    }
    

    .balance-card-accent .dropdown {
        overflow: visible !important;
    }

    /* Override any conflicting Bootstrap styles */
    .budget-dropdown-menu .dropdown-item {
        color: white !important;
        padding: 12px 16px !important;
        border-radius: 12px !important;
        margin-bottom: 4px !important;
        transition: all 0.3s ease !important;
    }

    .budget-dropdown-menu .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.1) !important;
        color: white !important;
        transform: translateX(4px);
    }
    
</style>
{% endblock %}