{% extends 'base.html' %}
{% block content %}
<div class="container-fluid p-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-4">Home</h2>
        </div>
    </div>

    <!-- Balance Cards -->
    <div class="row mb-4 align-items-stretch">
        <div class="col-md-4 mb-3 d-flex">
            <div class="card flex-fill" style="height:130px;">
                <div class="card-body stats-card">
                    <div class="stats-icon">
                        <i class="bi bi-wallet2"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="balance-amount">${{ user.balance|default('0.00') }}</h3>
                        <p>Total Balance</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3 d-flex">
            <div class="card flex-fill" style="height:130px;">
                <div class="card-body stats-card stats-card-debit">
                    <div class="stats-icon">
                        <i class="bi bi-arrow-up-right"></i>
                    </div>
                    <div class="stats-info">
                        <h3 class="md" id="monthlyDifference">$0.00</h3>
                        <p>Net This Month</p>
                        <small id="monthlyEarnedSpent"></small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3 d-flex">
            <div class="card flex-fill" style="height:130px;">
                <div class="card-body stats-card stats-card-budget">
                    <div class="stats-icon">
                        <i class="bi bi-wallet"></i>
                    </div>
                    <div class="stats-info">
                        <div class="dropdown">
                            <h5 class="dropdown-toggle" data-bs-toggle="dropdown" style="cursor:pointer;">
                                <span id="budgetName">{{ budgets[0].name if budgets else 'No Budget' }}</span>
                            </h5>
                            <ul class="dropdown-menu">
                                {% for budget in budgets %}
                                <li>
                                    <a class="dropdown-item" href="#"
                                        onclick="selectDisplayBudget('{{ budget.id }}', '{{ budget.name }}', '{{ budget.currency if budget.currency else '$' }}', '{{ '%.2f'|format(budget.amount if budget.amount else 0) }}');return false;">
                                        {{ budget.name }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <h3>
                            <span id="budgetCurrency">{{ budgets[0].currency if budgets and budgets[0].currency else '$'
                                }}</span>
                            <span id="budgetAmount">{{ '%.2f'|format(budgets[0].amount if budgets and budgets[0].amount
                                else 0) }}</span>
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Transaction Reports Card -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Transaction Reports</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="reportDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="reportDropdownLabel">Monthly</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#"
                                    onclick="loadReport('monthly');return false;">Monthly</a></li>
                            <li><a class="dropdown-item" href="#"
                                    onclick="loadReport('yearly');return false;">Yearly</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position:relative; width:100%; height:380px;">
                        <canvas id="transactionChart" style="width:100%;height:100%;"></canvas>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions Card -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Recent Transactions</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            Today
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Today</a></li>
                            <li><a class="dropdown-item" href="#">Yesterday</a></li>
                            <li><a class="dropdown-item" href="#">This Week</a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body p-0">
                    {% if transactions %}
                    <div class="table-responsive">
                        <table class="transaction-table dashboard-transaction-table">
                            <thead>
                                <tr>
                                    <th>Account</th>
                                    <th>Amount</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr>
                                    <td>
                                        <div class="transaction-account">
                                            <div class="transaction-icon">
                                                {% if tx.type|lower == 'payment' %}
                                                <i class="bi bi-credit-card text-primary"></i>
                                                {% elif tx.type|lower == 'transfer' %}
                                                <i class="bi bi-arrow-left-right text-success"></i>
                                                {% elif tx.type|lower == 'withdrawal' %}
                                                <i class="bi bi-cash text-danger"></i>
                                                {% else %}
                                                <i class="bi bi-currency-exchange text-warning"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <div class="transaction-vendor">{{ tx.type|capitalize }}</div>
                                                <div class="transaction-category">
                                                    {% if tx.sender_id == user.id %}
                                                    Sent{% if tx.receiver_id %} to {{ tx.receiver_id }}{% endif %}
                                                    {% elif tx.receiver_id == user.id %}
                                                    Received{% if tx.sender_id %} from {{ tx.sender_id }}{% endif %}
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div
                                            class="transaction-amount {{ 'amount-negative' if tx.sender_id == user.id else 'amount-positive' }}">
                                            {{ '-' if tx.sender_id == user.id else '+' }}${{ tx.amount }}
                                        </div>
                                    </td>
                                    <td>{{ tx.timestamp|format_date }}</td>
                                    <td>
                                        <span class="transaction-status
    {% if tx.status|lower == 'completed' %}
        success
    {% elif tx.status|lower == 'pending' %}
        pending
    {% else %}
        canceled
    {% endif %}">
                                            {{ tx.status|default('Completed')|capitalize }}
                                        </span>
                                    </td>
                                    <td class="transaction-time">{{ tx.timestamp|format_time }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div> {% else %}
                    <div class="no-transactions">
                        <i class="bi bi-credit-card"></i>
                        <h5>No transactions yet</h5>
                        <p>Your recent transactions will appear here</p>
                    </div>
                    {% endif %}
                    <a href="{{ url_for('transaction.send_money_route') }}" class="view-all-link">View All
                        Transactions</a>
                </div>
            </div>
        </div>

        <!-- Right column: Budgets and Expenses -->
        <div class="col-lg-4">
            <!-- Expenses Card (now below Budgets) -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>Expenses</div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            id="budgetDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <span id="budgetDropdownLabel">{{ budgets[0].name if budgets else 'No Budgets' }}</span>
                        </button>
                        <ul class="dropdown-menu" id="budgetDropdownMenu">
                            {% for budget in budgets %}
                            <li>
                                <a class="dropdown-item" href="#"
                                    onclick="selectBudget('{{ budget.id }}', '{{ budget.name }}');return false;">
                                    {{ budget.name }}
                                </a>
                            </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h3 class="mb-0" id="expenseTotal">$0</h3>
                        <p class="text-muted">Total</p>
                    </div>
                    <div class="expense-chart-scrollbox">
                        <canvas id="expenseChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    Category Budget Summary
                </div>
                <div class="card-body p-0">
                    <div id="category-summary-table"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Set current year for card expiration date
    document.addEventListener('DOMContentLoaded', function () {
        const currentYear = new Date().getFullYear();
        const expiryElements = document.querySelectorAll('.credit-card-inner .text-end div:last-child');
        expiryElements.forEach(el => {
            if (el.innerText.includes('/')) {
                el.innerText = `12/${currentYear + 1}`;
            }
        });
    });

    function drawHistogram(labels, received, spent, year, period) {
        const canvas = document.getElementById('transactionChart');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const width = canvas.width;
        // Draw year at top center if monthly
        if (period === 'monthly' && year) {
            ctx.fillStyle = "#fff";
            ctx.font = "20px Arial";
            ctx.textAlign = "center";
            ctx.fillText(year, width / 2, 30);
        }

        const height = canvas.height;
        const barWidth = Math.floor((width - 60) / (labels.length * 3));
        const maxVal = Math.max(...received, ...spent, 1);
        const yTicks = [0, Math.round(maxVal / 2), Math.round(maxVal)];
        if (period == 'monthly' && year) {
            ctx.fillStyle = "#fff"
        }
        // Draw Y axis grid lines and labels
        ctx.strokeStyle = "#eee";
        ctx.fillStyle = "#fff";
        ctx.font = "12px Arial";
        for (let i = 0; i < yTicks.length; i++) {
            let y = height - 20 - (yTicks[i] / maxVal) * (height - 60);
            ctx.beginPath();
            ctx.moveTo(40, y);
            ctx.lineTo(width - 10, y);
            ctx.stroke();
            ctx.fillText(yTicks[i], 25, y + 4);
        }

        // Draw X axis
        ctx.strokeStyle = "#aaa";
        ctx.beginPath();
        ctx.moveTo(40, height - 20);
        ctx.lineTo(width - 10, height - 20);
        ctx.stroke();

        // Draw bars and X labels
        for (let i = 0; i < labels.length; i++) {
            // Received (green)
            let barHeight = Math.round((received[i] / maxVal) * (height - 60));
            ctx.fillStyle = "#3ed6c2";
            ctx.fillRect(50 + i * barWidth * 3, height - 20 - barHeight, barWidth, barHeight);

            // Spent (red)
            barHeight = Math.round((spent[i] / maxVal) * (height - 60));
            ctx.fillStyle = "#ff6384";
            ctx.fillRect(50 + i * barWidth * 3 + barWidth, height - 20 - barHeight, barWidth, barHeight);

            // X label
            ctx.save();
            ctx.fillStyle = "#fff";
            ctx.font = "12px Arial";
            ctx.translate(50 + i * barWidth * 3 + barWidth / 2, height - 5);
            ctx.rotate(-Math.PI / 8);
            ctx.fillText(labels[i], 0, 0);
            ctx.restore();
        }

        // Y axis label
        ctx.save();
        ctx.translate(15, height / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.textAlign = "center";
        ctx.fillStyle = "#333";
        ctx.font = "16px Arial";
        ctx.fillText("Amount", 40, 0);
        ctx.restore();

        //X axis label
        // ctx.fillStyle = "#333";
        // ctx.font = "16px Arial";
        // ctx.textAlign = "center";
        // ctx.fillText("Period", width / 2, height);

        // Legend
        ctx.fillStyle = "#3ed6c2";
        ctx.fillRect(width - 150, 2, 12, 12);
        ctx.fillStyle = "#fff";
        ctx.font = "12px Arial";
        ctx.fillText("Received", width - 100, 12);
        ctx.fillStyle = "#ff6384";
        ctx.fillRect(width - 150, 20, 12, 12);
        ctx.fillStyle = "#fff";
        ctx.fillText("Spent", width - 110, 32);
    }

    function loadReport(period) {
        document.getElementById('reportDropdownLabel').innerText =
            period.charAt(0).toUpperCase() + period.slice(1);
        localStorage.setItem('transactionReportPeriod', period);
        fetch(`/api/transaction-report?period=${period}`)
            .then(res => res.json())
            .then(data => {
                drawHistogram(data.labels, data.received, data.spent, data.year, period);
            });
    }

    function resizeChart() {
        const canvas = document.getElementById('transactionChart');
        const container = canvas.parentElement;
        canvas.width = container.offsetWidth;
        canvas.height = container.offsetHeight;
    }
    document.addEventListener('DOMContentLoaded', resizeChart);
    window.addEventListener('resize', resizeChart);

    // Initial load
    document.addEventListener('DOMContentLoaded', function () {
        // Set canvas size
        const canvas = document.getElementById('transactionChart');
        canvas.width = 600;
        canvas.height = 250;
        const lastperiod = localStorage.getItem('transactionReportPeriod');
        if (lastperiod === 'weekly') {
            loadReport('monthly'); // fallback to monthly if previously set to weekly
        } else {
            loadReport(lastperiod || 'monthly');
        }
    });

    // function selectBudget(budgetId, budgetName) {
    //     document.getElementById('budgetDropdownLabel').innerText = budgetName;
    //     const expenseTotalEl = document.getElementById('expenseTotal');
    //     // Fetch and update expense chart data for the selected budget
    //     fetch(`/api/expense-report?budget_id=${budgetId}`)
    //         .then(res => res.json())
    //         .then(data => {
    //             // Update total amount
    //             expenseTotalEl.innerText = `$${data.totalAmount.toFixed(2)}`;
    //             // Update chart
    //             const ctx = document.getElementById('expenseChart').getContext('2d');
    //             ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    //             const labels = data.expenses.map(expense => expense.date);
    //             const amounts = data.expenses.map(expense => expense.amount);
    //             new Chart(ctx, {
    //                 type: 'bar',
    //                 data: {
    //                     labels: labels,
    //                     datasets: [{
    //                         label: 'Expenses',
    //                         data: amounts,
    //                         backgroundColor: '#3ed6c2',
    //                         borderColor: '#3ed6c2',
    //                         borderWidth: 1
    //                     }]
    //                 },
    //                 options: {
    //                     responsive: true,
    //                     scales: {
    //                         y: {
    //                             beginAtZero: true
    //                         }
    //                     }
    //                 }
    //             });
    //         });
    // }
    const categoryColors = {
        'Housing': '#FF6384',
        'Utilities': '#36A2EB',
        'Groceries': '#FFCE56',
        'Transportation': '#8A5FFF',
        'Healthcare': '#3ED6C2',
        'Insurance': '#FF9F40',
        'Education': '#4BC0C0',
        'Savings': '#9966FF',
        'Debt Payments': '#C9CBCF',
        'Personal Care': '#FF6384',
        'Entertainment': '#36A2EB',
        'Dining Out': '#FFCE56',
        'Clothing': '#8A5FFF',
        'Gifts & Donations': '#3ED6C2',
        'Travel': '#FF9F40',
        'Childcare': '#4BC0C0',
        'Pets': '#9966FF',
        'Other': '#C9CBCF'
    };

    let budgetsData = {{ budgets| tojson }};
    console.log("budgetsData:", budgetsData);
    let expenseChart;
    let currentBudgetId = localStorage.getItem('selectedBudgetId') || (budgetsData.length ? budgetsData[0].id : null);

    function selectBudget(budgetId, budgetName) {
        document.getElementById('budgetDropdownLabel').innerText = budgetName;
        currentBudgetId = budgetId;
        localStorage.setItem('selectedBudgetId', budgetId);
        updateExpenseChart();
    }

    function updateExpenseChart() {
        console.log("Calling updateExpenseChart");
        const budget = budgetsData.find(b => b.id == currentBudgetId);
        if (!budget) return;
        const categories = budget.categories || {};
        const labels = [];
        const data = [];
        const colors = [];
        for (const catName in categories) {
            labels.push(catName);
            let amount = categories[catName] || 0;
            data.push(amount);
            colors.push(categoryColors[catName] || '#C9CBCF');
        }
        // Calculate total and percentages
        const total = data.reduce((a, b) => a + b, 0);
        document.getElementById('expenseTotal').innerText = '$' + total.toFixed(2);

        // Update Chart.js
        if (expenseChart) {
            expenseChart.data.labels = labels;
            expenseChart.data.datasets[0].data = data;
            expenseChart.data.datasets[0].backgroundColor = colors;
            expenseChart.options.plugins.tooltip.callbacks = {
                label: function (context) {
                    const value = context.parsed;
                    const percent = total ? ((value / total) * 100).toFixed(1) : 0;
                    return `${context.label}: $${value} (${percent}%)`;
                }
            };
            expenseChart.update();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Chart.js
        const ctx = document.getElementById('expenseChart').getContext('2d');
        console.log("Creating Chart.js doughnut chart");
        expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.7)'
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                // This will be overwritten in updateExpenseChart
                                return '';
                            }
                        }
                    }
                },
                cutout: '70%'
            }
        });
        updateExpenseChart();
    });

    function selectDisplayBudget(budgetId, name, currency, amount) {
        document.getElementById('budgetName').textContent = name || 'No Budget';
        document.getElementById('budgetCurrency').textContent = currency || '$';
        // Always show two decimals
        document.getElementById('budgetAmount').textContent = parseFloat(amount).toFixed(2);
    }

    // Initialize with the first budget on page load
    document.addEventListener('DOMContentLoaded', function () {
        if (budgetsData && budgetsData.length > 0) {
            const firstBudget = budgetsData[0];
            selectDisplayBudget(
                firstBudget.id,
                firstBudget.name,
                firstBudget.currency || '$',
                firstBudget.amount || 0
            );
        }
    });
    console.log("Pie chart JS loaded");

    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/category-summary')
            .then(res => res.json())
            .then(data => {
                let html = `<div class="category-summary-scrollbox"><table class="category-summary-table table mb-0">
                    <thead>
                        <tr>
                            <th>Category</th>
                            <th>Budget</th>
                            <th>Expenditure</th>
                            <th>Condition</th>
                        </tr>
                    </thead>
                    <tbody>`;
                data.forEach(row => {
                    // Determine color for condition
                    let condColor = row.condition.includes('remaining') ? 'text-success' : 'text-danger';
                    html += `<tr>
                        <td>${row.category}</td>
                        <td>$${row.budget.toFixed(2)}</td>
                        <td>$${row.expenditure.toFixed(2)}</td>
                        <td><span class="${condColor}">${row.condition}</span></td>
                    </tr>`;
                });
                html += `</tbody></table></div>`;
                document.getElementById('category-summary-table').innerHTML = html;
            });
    });

    // Fetch monthly earned and spent, then show the difference
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/transaction-report?period=monthly')
            .then(res => res.json())
            .then(data => {
                const monthIndex = new Date().getMonth();
                const earned = data.received[monthIndex] || 0;
                const spent = data.spent[monthIndex] || 0;
                const difference = earned - spent;

                document.getElementById('monthlyDifference').innerText =
                    (difference >= 0 ? '+' : '') + '$' + difference.toFixed(2);
                document.getElementById('monthlyEarnedSpent').innerText =
                    `Earned: $${earned.toFixed(2)} | Spent: $${spent.toFixed(2)}`;
            });
    });
</script>
<style>
    .backgruond {
        z-index: 0;
    }

    .stats-card-budget {
        background-color: #5a67d8;
        background-image: linear-gradient(40deg, #5a67d8 0%, #7c3aed 100%);
        color: white;
        z-index: 0;
    }

    .stats-card-budget .stats-icon {
        background-color: rgba(255, 255, 255, 0.2);
    }

    .stats-card-budget h5 {
        color: #e2e8f0;
        margin-bottom: 8px;
    }

    .stats-card-budget .dropdown-toggle::after {
        margin-left: 0.5em;
        vertical-align: middle;
    }

    .stats-card-budget .dropdown-menu {
        max-height: 80 px;
        overflow-y: auto;
        z-index: 3;
    }

    #budgetCurrency {
        font-size: 1 rem;
        /* or any size you prefer */
        font-weight: bold;
    }

    #budgetAmount {
        font-size: 2.2rem;
        /* or any size you prefer */
        font-weight: bold;
    }

    .expense-chart-scrollbox {
        height: 300px;
        /* Fixed height for the chart area */
        overflow-y: auto;
        /* Enable vertical scrolling */
        padding: 10px 0;
        position: relative;
        background: transparent;
        /* Or your card background */
    }

    /* Make sure the canvas fills the scrollbox */
    #expenseChart {
        width: 100% !important;
        height: 100% !important;
        display: block;
    }

    /* Match the height of the recent transactions section */
    .category-summary-scrollbox {
        height: 485px;
        overflow-y: auto;
        background: transparent;
        padding: 0;
    }

    .category-summary-table {
        background: transparent;
        color: #e2e8f0;
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }

    .category-summary-table th,
    .category-summary-table td {
        background: transparent;
        color: #e2e8f0;
        border: 1px solid #353232;
        z-index: 3;
    }

    .category-summary-table th {
        position: sticky;
        top: 0;
        background: #181818;
        z-index: 2;
    }

    .category-summary-table tr:hover {
        background: transparent;
    }

    .text-success {
        color: #38d39f !important;
        font-weight: bold;
    }

    .text-danger {
        color: #ff6384 !important;
        font-weight: bold;
    }

    .balance-amount {
        font-size: 2.5rem !important;
        font-weight: bold !important;
    }

    .md {
        font-size: 1.8rem !important;
        font-weight: bold !important;
    }

    /* Make the budget dropdown always appear above other content */
    /* Make the budget dropdown scrollable and always above other content */
    .stats-card-budget .dropdown-menu {
        position: absolute !important;
        z-index: 1050 !important;
        /* Very high, above modals and backgrounds */
        left: 0;
        top: 100%;
        min-width: 100%;
        max-height: 199px;
        /* Set max height for scroll */
        overflow-y: auto;
        /* Enable vertical scrolling */
        background: #e2e8f0;
        color: #e2e8f0;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        border: 1px solid #353232;
    }

    /* Prevent parent from clipping dropdown */
    .stats-card-budget {
        overflow: visible !important;
        position: relative;
    }
    
</style>
{% endblock %}