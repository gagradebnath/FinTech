{% extends 'base.html' %}
{% block content %}
<style>
    /* Make the placeholder (first option) gray, others black */
    select.form-select option[value=""] {
        color: #888 !important;
    }

    select.form-select option:not([value=""]) {
        color: #000 !important;
    }
</style>

<div class="container py-4">
    <div class="row">
        <div class="col-lg-5">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="m-0">Send Money</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <div class="mb-3">
                            <label for="recipient_identifier" class="form-label">Recipient (User ID, Email, or
                                Phone)</label>
                            <input type="text" class="form-control" id="recipient_identifier"
                                name="recipient_identifier" placeholder="Enter User ID, Email, or Phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="amount" class="form-label">Amount</label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input type="number" class="form-control" id="amount" name="amount" min="0.01"
                                    step="0.01" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="payment_method" class="form-label">Payment Method</label>
                            <select class="form-select" id="payment_method" name="payment_method" required>
                                <option value="">Select Method</option>
                                <option value="cash">Cash</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="mobile">Mobile Wallet</option>
                                <option value="card">Credit/Debit Card</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="note" class="form-label">Note</label>
                            <input type="text" class="form-control" id="note" name="note" maxlength="255"
                                placeholder="What's this payment for?">
                        </div>
                        <div class="mb-3">
                            <label for="location" class="form-label">Location</label>
                            <input type="text" class="form-control" id="location" name="location" maxlength="255"
                                placeholder="Optional location">
                        </div>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">Send Money</button>
                        </div>
                    </form>
                </div>
            </div>
            <a href="{{ get_dashboard_url_for_user(user) }}" class="btn btn-outline-secondary mb-4">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>

        <div class="col-lg-7">
            <div class="modern-transaction-section">
                <div class="transactions-header">
                    <h3>Recent Transactions</h3>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            {% if time_filter == 'today' %}Today
                            {% elif time_filter == 'yesterday' %}Yesterday
                            {% elif time_filter == 'month' %}This Month
                            {% elif time_filter == 'all' %}All Time
                            {% else %}This Week
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('transaction.send_money_route', filter='today') }}">Today</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('transaction.send_money_route', filter='yesterday') }}">Yesterday</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('transaction.send_money_route', filter='week') }}">This Week</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('transaction.send_money_route', filter='month') }}">This Month</a></li>
                            <li><a class="dropdown-item" href="{{ url_for('transaction.send_money_route', filter='all') }}">All Time</a></li>
                        </ul>
                    </div>
                </div>

                {% if transactions %}
                <div class="table-responsive">
                    <table class="transaction-table">
                        <thead>
                            <tr>
                                <th>Account</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Status</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for tx in transactions %}
                            <tr>
                                <td>
                                    <div class="transaction-account">
                                        <div class="transaction-icon">
                                            {% if tx.type|lower == 'payment' %}
                                            <i class="bi bi-credit-card text-primary"></i>
                                            {% elif tx.type|lower == 'transfer' %}
                                            <i class="bi bi-arrow-left-right text-success"></i>
                                            {% elif tx.type|lower == 'withdrawal' %}
                                            <i class="bi bi-cash text-danger"></i>
                                            {% else %}
                                            <i class="bi bi-currency-exchange text-warning"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <div class="transaction-vendor">{{ tx.type|capitalize }}</div>
                                            <div class="transaction-category">
                                                {% if tx.sender_id == user.id %}
                                                Sent{% if tx.receiver_id %} to {{ tx.receiver_id }}{% endif %}
                                                {% elif tx.receiver_id == user.id %}
                                                Received{% if tx.sender_id %} from {{ tx.sender_id }}{% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div
                                        class="transaction-amount {{ 'amount-negative' if tx.sender_id == user.id else 'amount-positive' }}">
                                        {{ '-' if tx.sender_id == user.id else '+' }}${{ tx.amount }}
                                    </div>
                                </td>
                                <td>{{ tx.timestamp|format_date }}</td>
                                <td>
                                    <span
                                        class="transaction-status {{ 'success' if tx.status|lower == 'completed' else ('pending' if tx.status|lower == 'pending' else 'canceled') }}">
                                        {{ tx.status|default('Completed')|capitalize }}
                                    </span>
                                </td>
                                <td class="transaction-time">{{ tx.timestamp|format_time }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="no-transactions">
                    <i class="bi bi-credit-card"></i>
                    <h5>No transactions yet</h5>
                    <p>Your recent transactions will appear here</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay"
    style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.7); z-index:2000; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-3 text-primary fw-bold fs-4">Processing Transaction...</div>
</div>

<!-- Overspending Warning Modal -->
{% if overspending_warning %}
<div class="modal fade" id="overspendingWarningModal" tabindex="-1" aria-labelledby="overspendingWarningModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="overspendingWarningModalLabel">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>Overspending Alert
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" role="alert">
                    <h6 class="alert-heading">⚠️ Budget Exceeded</h6>
                    <p class="mb-3">{{ overspending_warning.message }}</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Transaction Details:</strong>
                            <ul class="list-unstyled mt-2">
                                <li><strong>Category:</strong> {{ overspending_warning.category }}</li>
                                <li><strong>Amount:</strong> ${{ "%.2f"|format(overspending_warning.expense_amount) }}</li>
                                <li><strong>Current Budget:</strong> ${{ "%.2f"|format(overspending_warning.budget) }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>Overspending Analysis:</strong>
                            <ul class="list-unstyled mt-2">
                                <li><strong>Over Budget By:</strong> 
                                    <span class="text-danger">${{ "%.2f"|format(overspending_warning.overspending_amount) }}</span>
                                </li>
                                <li><strong>Percentage Over:</strong> 
                                    <span class="text-danger">{{ "%.1f"|format(overspending_warning.percentage_over) }}%</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <strong>What would you like to do?</strong>
                    <p class="mb-0">You can still proceed with this transaction if you wish, or cancel and return to your dashboard.</p>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-between">
                <form method="POST" class="me-2">
                    <!-- Preserve form data -->
                    <input type="hidden" name="recipient_identifier" value="{{ overspending_warning.recipient_identifier }}">
                    <input type="hidden" name="amount" value="{{ overspending_warning.amount }}">
                    <input type="hidden" name="payment_method" value="{{ overspending_warning.payment_method }}">
                    <input type="hidden" name="note" value="{{ overspending_warning.note }}">
                    <input type="hidden" name="location" value="{{ overspending_warning.location }}">
                    <input type="hidden" name="cancel_transaction" value="1">
                    <button type="submit" class="btn btn-secondary">
                        <i class="bi bi-x-circle me-1"></i>Cancel Transaction
                    </button>
                </form>
                
                <form method="POST">
                    <!-- Preserve form data -->
                    <input type="hidden" name="recipient_identifier" value="{{ overspending_warning.recipient_identifier }}">
                    <input type="hidden" name="amount" value="{{ overspending_warning.amount }}">
                    <input type="hidden" name="payment_method" value="{{ overspending_warning.payment_method }}">
                    <input type="hidden" name="note" value="{{ overspending_warning.note }}">
                    <input type="hidden" name="location" value="{{ overspending_warning.location }}">
                    <input type="hidden" name="confirm_overspending" value="1">
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle me-1"></i>Proceed Anyway
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var warningModal = new bootstrap.Modal(document.getElementById('overspendingWarningModal'));
        warningModal.show();
    });
</script>
{% endif %}

<!-- Error popup -->
{% if error %}
<div class="modal fade" id="sendMoneyErrorModal" tabindex="-1" aria-labelledby="sendMoneyErrorModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="sendMoneyErrorModalLabel">Transaction Failed</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-black">
                {{ error }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var errorModal = new bootstrap.Modal(document.getElementById('sendMoneyErrorModal'));
        errorModal.show();
    });
</script>
{% endif %}

<!-- Overspending Warning Modal -->
{% if overspending_warning %}
<div class="modal fade" id="overspendingWarningModal" tabindex="-1" aria-labelledby="overspendingWarningModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="overspendingWarningModalLabel">
                    <i class="bi bi-exclamation-triangle"></i> Budget Warning
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-dark">
                <div class="alert alert-warning">
                    <h6><strong>{{ overspending_warning.message }}</strong></h6>
                    <hr>
                    <p><strong>Category:</strong> {{ overspending_warning.category }}</p>
                    <p><strong>Budget Remaining:</strong> ${{ "%.2f"|format(overspending_warning.budget) }}</p>
                    <p><strong>Transaction Amount:</strong> ${{ "%.2f"|format(overspending_warning.expense_amount) }}</p>
                    {% if overspending_warning.is_overspending %}
                    <p><strong>Amount Over Budget:</strong> ${{ "%.2f"|format(overspending_warning.overspending_amount) }}</p>
                    <p><strong>Percentage Over:</strong> {{ overspending_warning.percentage_over }}%</p>
                    {% endif %}
                </div>
                <p>Do you want to proceed with this transaction anyway?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="proceedWithTransaction()">
                    <i class="bi bi-arrow-right"></i> Proceed Anyway
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var overspendingModal = new bootstrap.Modal(document.getElementById('overspendingWarningModal'));
        overspendingModal.show();
    });

    function proceedWithTransaction() {
        // Add hidden input to force override
        var form = document.querySelector('form');
        var forceOverrideInput = document.createElement('input');
        forceOverrideInput.type = 'hidden';
        forceOverrideInput.name = 'force_override';
        forceOverrideInput.value = 'true';
        form.appendChild(forceOverrideInput);
        
        // Pre-fill the form with the previous data
        {% if form_data %}
        document.getElementById('recipient_identifier').value = '{{ form_data.recipient_identifier|e }}';
        document.getElementById('amount').value = '{{ form_data.amount|e }}';
        document.getElementById('payment_method').value = '{{ form_data.payment_method|e }}';
        document.getElementById('note').value = '{{ form_data.note|e }}';
        document.getElementById('location').value = '{{ form_data.location|e }}';
        {% endif %}
        
        // Hide modal and submit form
        var modal = bootstrap.Modal.getInstance(document.getElementById('overspendingWarningModal'));
        modal.hide();
        form.submit();
    }
</script>
{% endif %}

<!-- Success popup -->
{% if success %}
<div class="modal fade" id="sendMoneySuccessModal" tabindex="-1" aria-labelledby="sendMoneySuccessModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="sendMoneySuccessModalLabel">Transaction Successful</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-black"><!-- Add text-black here -->
                {{ success }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var successModal = new bootstrap.Modal(document.getElementById('sendMoneySuccessModal'));
        successModal.show();
    });
</script>
{% endif %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var sendMoneyForm = document.querySelector('form');
        var loadingOverlay = document.getElementById('loadingOverlay');
        
        if (sendMoneyForm && loadingOverlay) {
            sendMoneyForm.addEventListener('submit', function (e) {
                // Check if this is a force override submission
                var forceOverride = document.querySelector('input[name="force_override"]');
                if (forceOverride && forceOverride.value === 'true') {
                    // Allow the form to submit normally
                    loadingOverlay.style.display = 'flex';
                    return;
                }
                
                // Prevent default submission to check for overspending first
                e.preventDefault();
                
                // Get form data
                var formData = new FormData(sendMoneyForm);
                var amount = formData.get('amount');
                var note = formData.get('note');
                
                // Check for overspending via API
                fetch('/api/check-overspending', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount,
                        description: note || ''
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.overspending_info.is_overspending) {
                        // Show overspending warning modal
                        showOverspendingWarning(data.overspending_info);
                    } else {
                        // No overspending, proceed with normal submission
                        loadingOverlay.style.display = 'flex';
                        sendMoneyForm.submit();
                    }
                })
                .catch(error => {
                    console.error('Error checking overspending:', error);
                    // If there's an error, proceed with normal submission
                    loadingOverlay.style.display = 'flex';
                    sendMoneyForm.submit();
                });
            });
        }
    });

    function showOverspendingWarning(overspendingInfo) {
        // Create modal dynamically if not from server-side warning
        var modalHtml = `
            <div class="modal fade" id="dynamicOverspendingWarningModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-warning text-dark">
                            <h5 class="modal-title">
                                <i class="bi bi-exclamation-triangle"></i> Budget Warning
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-dark">
                            <div class="alert alert-warning">
                                <h6><strong>${overspendingInfo.message}</strong></h6>
                                <hr>
                                <p><strong>Category:</strong> ${overspendingInfo.category}</p>
                                <p><strong>Budget Remaining:</strong> $${overspendingInfo.budget.toFixed(2)}</p>
                                <p><strong>Transaction Amount:</strong> $${overspendingInfo.expense_amount.toFixed(2)}</p>
                                <p><strong>Amount Over Budget:</strong> $${overspendingInfo.overspending_amount.toFixed(2)}</p>
                                <p><strong>Percentage Over:</strong> ${overspendingInfo.percentage_over}%</p>
                            </div>
                            <p>Do you want to proceed with this transaction anyway?</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-warning" onclick="proceedWithDynamicTransaction()">
                                <i class="bi bi-arrow-right"></i> Proceed Anyway
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Remove existing dynamic modal if any
        var existingModal = document.getElementById('dynamicOverspendingWarningModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Show modal
        var modal = new bootstrap.Modal(document.getElementById('dynamicOverspendingWarningModal'));
        modal.show();
    }

    function proceedWithDynamicTransaction() {
        // Add hidden input to force override
        var form = document.querySelector('form');
        var forceOverrideInput = document.createElement('input');
        forceOverrideInput.type = 'hidden';
        forceOverrideInput.name = 'force_override';
        forceOverrideInput.value = 'true';
        form.appendChild(forceOverrideInput);
        
        // Hide modal and submit form
        var modal = bootstrap.Modal.getInstance(document.getElementById('dynamicOverspendingWarningModal'));
        modal.hide();
        
        // Show loading overlay
        var loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = 'flex';
        }
        
        form.submit();
    }
</script>
{% endblock %}