{% extends "base.html" %}

{% block title %}Blockchain Database View - FinGuard{% endblock %}

{% block extra_css %}
<style>
    .database-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }
    
    .table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 30px;
    }
    
    .table-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        font-weight: bold;
        color: #495057;
    }
    
    .hash-display {
        font-family: 'Courier New', monospace;
        font-size: 0.8em;
        background: #f1f1f1;
        padding: 2px 5px;
        border-radius: 3px;
    }
    
    .positive-amount {
        color: #28a745;
        font-weight: bold;
    }
    
    .negative-amount {
        color: #dc3545;
        font-weight: bold;
    }
    
    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2><i class="fas fa-database"></i> Blockchain Database View</h2>
    
    <!-- Database Statistics -->
    <div class="database-header">
        <h4>Database Statistics</h4>
        <div class="row">
            <div class="col-md-6">
                <div class="stat-card">
                    <h5>{{ block_count }}</h5>
                    <p>Total Blocks in DB</p>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stat-card">
                    <h5>{{ tx_count }}</h5>
                    <p>Total Transactions in DB</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Blockchain Table -->
    <div class="table-container">
        <div class="table-header">
            <i class="fas fa-cubes"></i> Blockchain Table (Recent 20 blocks)
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>ID</th>
                        <th>Index</th>
                        <th>Type</th>
                        <th>Timestamp</th>
                        <th>Previous Hash</th>
                        <th>Current Hash</th>
                        <th>Transaction ID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for block in blockchain_data %}
                    <tr>
                        <td><small>{{ block.id[:8] }}...</small></td>
                        <td><span class="badge badge-primary">{{ block.index }}</span></td>
                        <td>{{ block.type }}</td>
                        <td><small>{{ block.timestamp|format_datetime }}</small></td>
                        <td>
                            {% if block.prev_hash_short %}
                                <span class="hash-display">{{ block.prev_hash_short }}...</span>
                            {% else %}
                                <span class="text-muted">Genesis</span>
                            {% endif %}
                        </td>
                        <td><span class="hash-display">{{ block.hash_short }}...</span></td>
                        <td>
                            {% if block.transaction_id %}
                                <small>{{ block.transaction_id[:8] }}...</small>
                            {% else %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Blockchain Transactions Table -->
    <div class="table-container">
        <div class="table-header">
            <i class="fas fa-exchange-alt"></i> Blockchain Transactions Table (Recent 50 transactions)
        </div>
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="thead-light">
                    <tr>
                        <th>ID</th>
                        <th>User</th>
                        <th>Amount</th>
                        <th>Current Balance</th>
                        <th>Method</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions_data %}
                    <tr>
                        <td><small>{{ tx.id[:8] }}...</small></td>
                        <td>
                            {% if tx.first_name and tx.last_name %}
                                {{ tx.first_name }} {{ tx.last_name }}
                                <br><small class="text-muted">{{ tx.user_id[:8] }}...</small>
                            {% else %}
                                <small class="text-muted">{{ tx.user_id[:8] }}...</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if tx.amount >= 0 %}
                                <span class="positive-amount">+${{ "%.2f"|format(tx.amount) }}</span>
                            {% else %}
                                <span class="negative-amount">${{ "%.2f"|format(tx.amount) }}</span>
                            {% endif %}
                        </td>
                        <td>${{ "%.2f"|format(tx.current_balance) }}</td>
                        <td>
                            <span class="badge badge-info">{{ tx.method }}</span>
                        </td>
                        <td><small>{{ tx.timestamp|format_datetime }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Refresh Button -->
    <div class="text-center mt-4">
        <button class="btn btn-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
        <a href="{{ url_for('blockchain.blockchain_explorer') }}" class="btn btn-secondary ml-2">
            <i class="fas fa-arrow-left"></i> Back to Explorer
        </a>
    </div>
    
    <!-- SQL Query Examples -->
    <div class="mt-5">
        <h5>Sample SQL Queries</h5>
        <div class="card">
            <div class="card-body">
                <h6>Query blockchain table:</h6>
                <code>SELECT * FROM blockchain ORDER BY `index` DESC;</code>
                
                <h6 class="mt-3">Query blockchain transactions:</h6>
                <code>SELECT * FROM blockchain_transactions ORDER BY timestamp DESC;</code>
                
                <h6 class="mt-3">Join both tables:</h6>
                <code>
                    SELECT b.index, b.hash, bt.amount, bt.method 
                    FROM blockchain b 
                    LEFT JOIN blockchain_transactions bt ON b.transaction_id = bt.id
                    ORDER BY b.index DESC;
                </code>
            </div>
        </div>
    </div>
</div>
{% endblock %}
